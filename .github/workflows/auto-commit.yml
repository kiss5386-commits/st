name: GPT Auto Commit (apply changes via PR)

on:
  workflow_dispatch:
    inputs:
      instructions:
        description: "ì´ë²ˆì— ì½”ë“œì— ì ìš©í•  ë³€ê²½ ì§€ì‹œë¬¸ (í•œêµ­ì–´ OK)"
        required: true
        default: |
          ëª©ì : ì„¤ì •ì°½ì—ì„œ Bybit/Bitget ê³µí†µ í•„ìˆ˜ê°’ ê²€ì¦ ê°•í™”
          ìš”êµ¬ì‚¬í•­:
            - configs/schema.yaml: api_key, api_secret í•„ìˆ˜ / leverage 1~125 / slippage_bps 0~100 / order_timeout_ms 500~60000
            - server/settings.py: ìœ„ ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ ê²€ì¦, ìœ„ë°˜ ì‹œ ValidationError
            - server/routes/settings.py: PUT /settings ì‹¤íŒ¨ ì‹œ 400 + code=VALIDATION_ERROR + í•„ë“œë³„ ë©”ì‹œì§€
          ì•ˆì „:
            - .github, secrets, keys, certs ë””ë ‰í† ë¦¬ëŠ” ìˆ˜ì • ê¸ˆì§€
            - ë¦¬ìŠ¤í¬ ë¡œì§(ì†ì ˆ/íŠ¸ë ˆì¼ë§/ì¿¨ë‹¤ìš´) ê¸°ë³¸ê°’/íë¦„ ë³€ê²½ ê¸ˆì§€

permissions:
  contents: write
  pull-requests: write

jobs:
  pr:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openai==1.* pyyaml==6.*

      - name: Create GPT patcher (script)
        shell: bash
        run: |
          cat > "$RUNNER_TEMP/gpt_patcher.py" <<'PY'
          # ðŸ‘‡ ì—¬ê¸° ë°©ê¸ˆ ë“œë¦° Python ì „ì²´ ì½”ë“œ ë¸”ë¡ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤
          (ìœ„ì—ì„œ ì„¤ëª…í•œ ensure_dirs_for_patch í¬í•¨ëœ ì½”ë“œ)
          PY

      - name: Run GPT patcher (dry-run + apply)
        env:
          USER_INSTRUCTIONS: ${{ github.event.inputs.instructions }}
        run: |
          python "$RUNNER_TEMP/gpt_patcher.py"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "GPT: apply changes"
          title: "GPT: proposed changes"
          body: |
            ìžë™ ìƒì„±ëœ PRìž…ë‹ˆë‹¤.

            ì§€ì‹œë¬¸:
            ```
            ${{ github.event.inputs.instructions }}
            ```
          branch: gpt/change-${{ github.run_id }}
          base: ${{ github.event.repository.default_branch }}
          delete-branch: true

      - name: Enable auto-merge (optional)
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
