name: GPT Auto Code Modification

on:
  workflow_dispatch:
    inputs:
      instructions:
        description: 'í•œê¸€ ì§€ì‹œë¬¸ (ì½”ë“œ ìˆ˜ì • ë‚´ìš©)'
        required: true
        type: string
      model:
        description: 'OpenAI ëª¨ë¸ ì„ íƒ'
        required: false
        default: 'gpt-5-mini'
        type: choice
        options:
          - 'gpt-5'
          - 'gpt-5-mini'
          - 'gpt-5-nano'
          - 'gpt-4o'
          - 'gpt-4o-mini'
          - 'o1-preview'
          - 'o1-mini'
      max_files:
        description: 'ìµœëŒ€ ì²˜ë¦¬ íŒŒì¼ ìˆ˜'
        required: false
        default: '10'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-modify:
    runs-on: ubuntu-latest
    env:
      OPENAI_MODEL: gpt-5-mini   # ëª¨ë¸ ê³ ì •(ê¸°ë³¸)
      MAX_FILES: "1"             # GPT ê²½ë¡œì—ì„œ ì²¨ë¶€ íŒŒì¼ ìˆ˜ ì œí•œ
      TOKEN_BUDGET: "12000"      # GPT ê²½ë¡œ ì…ë ¥ í† í° ìƒí•œ
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "openai>=1.0.0,<2" "PyYAML>=6.0,<7"

      - name: Configure Git
        run: |
          git config --global user.name "GPT Auto Modifier"
          git config --global user.email "gpt-auto@noreply.github.com"

      - name: Backup current state
        run: |
          git add -A
          git stash push -m "Backup before GPT modification - $(date)" || true
          echo "ğŸ”’ í˜„ì¬ ìƒíƒœ ë°±ì—… ì™„ë£Œ"

      - name: Python syntax check
        run: python -m py_compile gpt_patcher.py

      - name: Execute GPT Patcher
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          USER_INSTRUCTIONS: ${{ github.event.inputs.instructions }}
          # ì…ë ¥ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ job env ê¸°ë³¸ê°’ ì‚¬ìš©
          OPENAI_MODEL: ${{ github.event.inputs.model || env.OPENAI_MODEL }}
          MAX_FILES: ${{ github.event.inputs.max_files || env.MAX_FILES }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          echo "ğŸš€ GPT íŒ¨ì²˜ ì‹¤í–‰ ì‹œì‘"
          echo "ğŸ“ ì§€ì‹œë¬¸(ì• 120ì):"
          printf '%s' "$USER_INSTRUCTIONS" | head -c 120 | sed 's/`/Â´/g'
          echo
          echo "ğŸ¤– ëª¨ë¸: $OPENAI_MODEL"
          echo "ğŸ“‚ ìµœëŒ€ íŒŒì¼: $MAX_FILES"

          python3 gpt_patcher.py

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "ë³€ê²½ì‚¬í•­ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ“‹ ë³€ê²½ëœ íŒŒì¼:"
            git diff --name-status || true
            git diff --cached --name-status || true
          fi

      - name: Commit & Push
        if: ${{ success() && (github.event.inputs.dry_run == '' || github.event.inputs.dry_run != 'true') }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "st-bot"
          git config user.email "st-bot@users.noreply.github.com"

          git add -A

          # ë³€ê²½ ì—†ìœ¼ë©´ ìŠ¤í‚µ
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          # ì…ë ¥ JSONì—ì„œ plan ì´ë¦„ë§Œ ì•ˆì „í•˜ê²Œ ì¶”ì¶œ (jq ì—†ìœ¼ë©´ ë¹ˆê°’)
          PLAN_NAME=$(printf '%s' "${{ github.event.inputs.instructions }}" | jq -r '.plan // empty' 2>/dev/null || true)
          [ -z "$PLAN_NAME" ] && PLAN_NAME="apply plan"

          git commit -m "gpt-patcher: ${PLAN_NAME}" \
                     -m "Run ID: ${{ github.run_id }}" \
                     -m "Model: ${{ github.event.inputs.model || env.OPENAI_MODEL }}"

          git push

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        id: create_pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gpt/auto-${{ github.run_id }}
          # ì§€ì‹œë¬¸ ë…¸ì¶œ/ì¸ì ì…˜ ë°©ì§€ë¥¼ ìœ„í•´ ì•ˆì „í•œ ì œëª© ì‚¬ìš©
          title: "gpt-patcher: ${{ github.run_id }}"

          body: |
            ## ğŸ¤– GPT ìë™ ì½”ë“œ ìˆ˜ì •

            **âš™ï¸ ì„¤ì •:**
            - **ëª¨ë¸:** ${{ github.event.inputs.model || env.OPENAI_MODEL }}
            - **ìµœëŒ€ íŒŒì¼:** ${{ github.event.inputs.max_files || env.MAX_FILES }}
            - **Run ID:** ${{ github.run_id }}

            **ğŸ“‹ ë³€ê²½ì‚¬í•­:**
            ì´ PRì—ëŠ” GPT íŒ¨ì²˜ê°€ ìë™ìœ¼ë¡œ ìƒì„±/ìˆ˜ì •í•œ íŒŒì¼ë“¤ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
          commit-message: "gpt-patcher: auto"
          delete-branch: true
          assignees: ${{ github.actor }}
          reviewers: ${{ github.actor }}

      - name: Auto-merge PR (ì„ íƒì )
        if: steps.changes.outputs.has_changes == 'true' && contains(github.event.inputs.instructions, '[AUTO_MERGE]')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --head "gpt/auto-${{ github.run_id }}" --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            echo "ğŸ”„ PR #$PR_NUMBER ìë™ ë¨¸ì§€ ì‹œë„"
            sleep 5
            gh pr merge "$PR_NUMBER" --squash --auto || {
              echo "âš ï¸ ìë™ ë¨¸ì§€ ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
              gh pr comment "$PR_NUMBER" --body "âš ï¸ ìë™ ë¨¸ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½”ë“œ ë¦¬ë·° í›„ ìˆ˜ë™ìœ¼ë¡œ ë¨¸ì§€í•´ì£¼ì„¸ìš”."
            }
            echo "âœ… ìë™ ë¨¸ì§€ ì²˜ë¦¬ ì™„ë£Œ"
          else
            echo "âŒ PRì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "ğŸ’¥ ì‘ì—… ì‹¤íŒ¨ - ì •ë¦¬ ì‘ì—… ì‹œì‘"
          git stash pop 2>/dev/null || echo "ë³µì›í•  ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤"
          git branch -D "gpt/auto-${{ github.run_id }}" 2>/dev/null || true
          echo "ğŸ§¹ ì •ë¦¬ ì‘ì—… ì™„ë£Œ"

      - name: Summary
        if: always()
        run: |
          echo "ğŸ“Š GPT ìë™ ìˆ˜ì • ìš”ì•½"
          echo "===================="
          echo "ğŸ“ ì§€ì‹œë¬¸(ì• 120ì):"
          printf '%s' "${{ github.event.inputs.instructions }}" | head -c 120 | sed 's/`/Â´/g'
          echo
          echo "ğŸ¤– ëª¨ë¸: ${{ github.event.inputs.model || env.OPENAI_MODEL }}"
          echo "ğŸ“‚ ìµœëŒ€ íŒŒì¼: ${{ github.event.inputs.max_files || env.MAX_FILES }}"
          echo "ğŸ”„ Run ID: ${{ github.run_id }}"
          if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… ìƒíƒœ: ë³€ê²½ì‚¬í•­ ìˆìŒ - PR ìƒì„±ë¨"
          else
            echo "â„¹ï¸ ìƒíƒœ: ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi
          echo "===================="
