name: GPT Auto Commit (apply changes via PR)

on:
  workflow_dispatch:
    inputs:
      instructions:
        description: "ì´ë²ˆì— ì½”ë“œì— ì ìš©í•  ë³€ê²½ ì§€ì‹œë¬¸ (í•œêµ­ì–´ OK)"
        required: true
        default: |
          ëª©ì : ì„¤ì •ì°½ì—ì„œ Bybit/Bitget ê³µí†µ í•„ìˆ˜ê°’ ê²€ì¦ ê°•í™”
          ìš”êµ¬ì‚¬í•­:
            - configs/schema.yaml: api_key, api_secret í•„ìˆ˜ / leverage 1~125 / slippage_bps 0~100 / order_timeout_ms 500~60000
            - server/settings.py: ìœ„ ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ ê²€ì¦, ìœ„ë°˜ ì‹œ ValidationError
            - server/routes/settings.py: PUT /settings ì‹¤íŒ¨ ì‹œ 400 + code=VALIDATION_ERROR + í•„ë“œë³„ ë©”ì‹œì§€
          ì•ˆì „:
            - .github, secrets, keys, certs ë””ë ‰í† ë¦¬ëŠ” ìˆ˜ì • ê¸ˆì§€
            - ë¦¬ìŠ¤í¬ ë¡œì§(ì†ì ˆ/íŠ¸ë ˆì¼ë§/ì¿¨ë‹¤ìš´) ê¸°ë³¸ê°’/íë¦„ ë³€ê²½ ê¸ˆì§€

permissions:
  contents: write
  pull-requests: write

jobs:
  pr:
    runs-on: ubuntu-latest
    env:
      # ðŸ”‘ ì—¬ê¸°ì„œ OpenAI í‚¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. (ì´ë¯¸ Secretsì— ë„£ìœ¼ì…¨ìŒ)
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openai==1.* pyyaml==6.*

      - name: Create GPT patcher (script)
        shell: bash
        run: |
          cat > "$RUNNER_TEMP/gpt_patcher.py" <<'PY'
          # (ì—¬ê¸°ì— ì›ëž˜ gpt_patcher.py ì½”ë“œ ë‚´ìš© ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°)
          PY

          # ìˆ˜ì • í—ˆìš©/ì°¨ë‹¨ ê²½ë¡œ (ì•ˆì „ìž¥ì¹˜)
          SAFE_PATHS = ["app", "server", "configs", "stargate_all_in_one.py"]
          DENY_PATHS = [".github", "secrets", "keys", "certs"]

          TEMPLATE = """
          ë„ˆëŠ” ì‹œë“œ ë³´í˜¸ê°€ ìµœìš°ì„ ì¸ ì‹œë‹ˆì–´ íŒŒì´ì¬ ì—”ì§€ë‹ˆì–´ë‹¤.
          ì•„ëž˜ 'ì§€ì‹œë¬¸'ì„ ë§Œì¡±í•˜ë„ë¡ ë ˆí¬ì˜ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ëŠ” **ìœ ë‹ˆíŒŒì´ë“œ íŒ¨ì¹˜(git apply í˜•ì‹)**ë§Œ ìƒì„±í•˜ë¼.
          ê·œì¹™:
          - SAFE_PATHS ì•ˆì—ì„œë§Œ ìˆ˜ì •í•˜ê³ , DENY_PATHSì—ëŠ” ì ˆëŒ€ ì†ëŒ€ì§€ ë§ ê²ƒ.
          - ê¸°ì¡´ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë¡œì§(ì†ì ˆ/íŠ¸ë ˆì¼ë§/ì¿¨ë‹¤ìš´)ì˜ ê¸°ë³¸ê°’/íë¦„ì€ ìœ ì§€.
          - íŒŒì¼ ìˆ˜ì • ì‹œì—ëŠ” **ìˆ˜ì •ëœ ì „ì²´ íŒŒì¼ ë‚´ìš©**ì„ í¬í•¨í•œ íŒ¨ì¹˜ë¥¼ ìƒì„±.
          - ì• ë§¤í•˜ë©´ TODO ì£¼ì„ì„ ë‚¨ê¸°ê³  ê³¼í•œ ì¶”ì¸¡ì€ ê¸ˆì§€.
          - ì¶œë ¥ì—ëŠ” íŒ¨ì¹˜ ë‚´ìš©ë§Œ í¬í•¨(ì„¤ëª…/ë¬¸ìž¥ ê¸ˆì§€).

          SAFE_PATHS={safe}
          DENY_PATHS={deny}

          ì§€ì‹œë¬¸:
          {inst}
          """

          def run(cmd):
            return subprocess.check_output(cmd, text=True).strip()

          def ensure_clean():
            status = run(["git","status","--porcelain"])
            if status:
              print("Worktree not clean", file=sys.stderr); sys.exit(1)

          def main():
            ensure_clean()
            instructions = os.environ.get("USER_INSTRUCTIONS","").strip()
            if not instructions:
              print("No instructions provided", file=sys.stderr); sys.exit(2)

            prompt = TEMPLATE.format(
              safe=",".join(SAFE_PATHS),
              deny=",".join(DENY_PATHS),
              inst=instructions
            )

            client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])
            resp = client.chat.completions.create(
              model="gpt-4o-mini",
              messages=[{"role":"user","content":prompt}],
              temperature=0.1,
            )
            patch = resp.choices[0].message.content.strip()

            # ìµœì†Œ ê²€ì¦: diff í—¤ë” í™•ì¸
            if not re.search(r"^diff --git a/", patch, flags=re.M):
              print("No unified diff found from GPT.", file=sys.stderr)
              print(patch[:800])
              sys.exit(3)

            # ê¸ˆì§€ ê²½ë¡œ í„°ì¹˜ ì—¬ë¶€ ê²€ì‚¬
            for line in patch.splitlines():
              if line.startswith(("+++ b/","--- a/")):
                path = line.split("\t")[0].split(" ",1)[-1][2:]
                if any(f"/{d.strip('/')}/" in f"/{path}" for d in DENY_PATHS):
                  print(f"Patch touches denied path: {path}", file=sys.stderr)
                  sys.exit(4)

            # dry-run ê²€ì‚¬
            pathlib.Path(".gpt_patch.diff").write_text(patch, encoding="utf-8")
            subprocess.check_call(["git","apply","--check",".gpt_patch.diff"])
            print("DRY-RUN OK")

            # ì‹¤ì œ ì ìš©
            subprocess.check_call(["git","apply",".gpt_patch.diff"])
            print("PATCH APPLIED")

          if __name__ == "__main__":
            main()
          PY

      - name: Run GPT patcher (dry-run + apply)
        env:
          USER_INSTRUCTIONS: ${{ github.event.inputs.instructions }}
        run: |
          python "$RUNNER_TEMP/gpt_patcher.py"

      # ì—¬ê¸°ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ì´ ì›Œí‚¹ë””ë ‰í† ë¦¬ì— ì¡´ìž¬ â†’ ì•„ëž˜ ì•¡ì…˜ì´ PRì„ ìƒì„±í•´ì¤ë‹ˆë‹¤.
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "GPT: apply changes"
          title: "GPT: proposed changes"
          body: |
            ìžë™ ìƒì„±ëœ PRìž…ë‹ˆë‹¤.

            ì§€ì‹œë¬¸:
            ```
            ${{ github.event.inputs.instructions }}
            ```
          branch: gpt/change-${{ github.run_id }}
          base: ${{ github.event.repository.default_branch }}
          delete-branch: true

      - name: Enable auto-merge (optional)
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
